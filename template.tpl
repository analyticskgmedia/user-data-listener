___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "User Data Listener",
  "brand": {
    "id": "kg_media",
    "displayName": "KG Media",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Capture user data from forms, purchases, and interactions without requiring code changes. Automatically listens for email, phone, name, and address data.",
  "categories": ["MARKETING", "PERSONALIZATION", "UTILITY"],
  "containerContexts": ["WEB"]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "captureSettings",
    "displayName": "Data Capture Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "captureEmail",
        "checkboxText": "Capture Email Addresses",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "capturePhone",
        "checkboxText": "Capture Phone Numbers",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "captureName",
        "checkboxText": "Capture Names (First & Last)",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "captureAddress",
        "checkboxText": "Capture Address Information",
        "simpleValueType": true,
        "defaultValue": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "dataOutput",
    "displayName": "Data Output Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "outputMethod",
        "displayName": "Output Method",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "dataLayer",
            "displayValue": "Push to dataLayer"
          },
          {
            "value": "localStorage",
            "displayValue": "Save to localStorage"
          },
          {
            "value": "both",
            "displayValue": "Both dataLayer and localStorage"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "dataLayer"
      },
      {
        "type": "TEXT",
        "name": "dataLayerEventName",
        "displayName": "dataLayer Event Name",
        "simpleValueType": true,
        "defaultValue": "userData.captured"
      },
      {
        "type": "TEXT",
        "name": "localStorageKey",
        "displayName": "localStorage Key",
        "simpleValueType": true,
        "defaultValue": "kg_media_user_data"
      },
      {
        "type": "CHECKBOX",
        "name": "autoRestore",
        "checkboxText": "Auto-restore from localStorage",
        "simpleValueType": true,
        "defaultValue": true
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enableLogging",
    "checkboxText": "Enable Console Logging",
    "simpleValueType": true,
    "defaultValue": false
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const createQueue = require('createQueue');
const copyFromDataLayer = require('copyFromDataLayer');
const localStorage = require('localStorage');
const queryPermission = require('queryPermission');
const makeString = require('makeString');
const getTimestampMillis = require('getTimestampMillis');
const JSON = require('JSON');
const isConsentGranted = require('isConsentGranted');

// Check Google Consent Mode
const adStorageGranted = isConsentGranted('ad_storage');
const analyticsStorageGranted = isConsentGranted('analytics_storage');
const adUserDataGranted = isConsentGranted('ad_user_data');

// Check if we should proceed based on consent
let shouldProceed = false;

if (data.outputMethod === 'dataLayer' || data.outputMethod === 'both') {
  if (analyticsStorageGranted || (adStorageGranted && adUserDataGranted)) {
    shouldProceed = true;
  }
}

if (data.outputMethod === 'localStorage') {
  if (analyticsStorageGranted) {
    shouldProceed = true;
  }
}

if (!shouldProceed) {
  if (data.enableLogging) {
    log('User Data Listener: Insufficient consent granted');
  }
  data.gtmOnSuccess();
  return;
}

// Create dataLayer push function
const dataLayerPush = createQueue('dataLayer');

// Initialize captured data storage
let capturedData = {};

// Auto-restore from localStorage
if (data.autoRestore && (data.outputMethod === 'localStorage' || data.outputMethod === 'both')) {
  if (queryPermission('access_local_storage', 'read', data.localStorageKey)) {
    const storedDataString = localStorage.getItem(data.localStorageKey);
    
    if (storedDataString) {
      const storedData = JSON.parse(storedDataString);
      
      if (storedData && storedData.userData) {
        const restoredEvent = {
          event: 'userData.restored'
        };
        
        for (let key in storedData.userData) {
          if (storedData.userData.hasOwnProperty(key)) {
            restoredEvent['userData.' + key] = storedData.userData[key];
          }
        }
        
        dataLayerPush(restoredEvent);
        
        if (data.enableLogging) {
          log('User Data Listener: Restored data', restoredEvent);
        }
      }
    }
  }
}

// Process data
const processData = function(type, value) {
  if (!value) return;
  
  value = value.trim();
  if (!value) return;
  
  capturedData[type] = value;
  
  if (data.enableLogging) {
    log('User Data Listener: Captured', type, ':', value);
  }
};

// Send data with merging
const sendData = function() {
  let hasData = false;
  for (let key in capturedData) {
    if (capturedData.hasOwnProperty(key)) {
      hasData = true;
      break;
    }
  }
  
  if (!hasData) return;
  
  let finalData = capturedData;
  
  // Merge with existing localStorage data
  if (data.outputMethod === 'localStorage' || data.outputMethod === 'both') {
    if (queryPermission('access_local_storage', 'read', data.localStorageKey)) {
      const existingDataString = localStorage.getItem(data.localStorageKey);
      if (existingDataString) {
        const existingData = JSON.parse(existingDataString);
        if (existingData && existingData.userData) {
          finalData = {};
          // Copy existing
          for (let key in existingData.userData) {
            if (existingData.userData.hasOwnProperty(key)) {
              finalData[key] = existingData.userData[key];
            }
          }
          // Overwrite with new
          for (let key in capturedData) {
            if (capturedData.hasOwnProperty(key)) {
              finalData[key] = capturedData[key];
            }
          }
        }
      }
    }
  }
  
  // Push to dataLayer
  if (data.outputMethod === 'dataLayer' || data.outputMethod === 'both') {
    const eventData = {
      event: data.dataLayerEventName
    };
    
    for (let key in finalData) {
      if (finalData.hasOwnProperty(key)) {
        eventData['userData.' + key] = finalData[key];
      }
    }
    
    dataLayerPush(eventData);
  }
  
  // Save to localStorage
  if (data.outputMethod === 'localStorage' || data.outputMethod === 'both') {
    if (queryPermission('access_local_storage', 'write', data.localStorageKey)) {
      const dataToStore = {
        timestamp: makeString(getTimestampMillis()),
        userData: finalData
      };
      
      localStorage.setItem(data.localStorageKey, JSON.stringify(dataToStore));
    }
  }
};

// Process form
const processForm = function() {
  // Enhanced form field detection
  for (let i = 0; i < 50; i++) {
    const fieldName = copyFromDataLayer('gtm.element.elements.' + i + '.name');
    const fieldValue = copyFromDataLayer('gtm.element.elements.' + i + '.value');
    const fieldType = copyFromDataLayer('gtm.element.elements.' + i + '.type');
    
    if (fieldName && fieldValue) {
      const nameLower = fieldName.toLowerCase();
      const typeLower = (fieldType || '').toLowerCase();
      
      if (data.captureEmail && (typeLower === 'email' || nameLower.indexOf('email') > -1)) {
        if (fieldValue.indexOf('@') > 0) {
          processData('email', fieldValue);
        }
      }
      else if (data.capturePhone && (typeLower === 'tel' || nameLower.indexOf('phone') > -1 || nameLower.indexOf('tel') > -1)) {
        processData('phone', fieldValue);
      }
      else if (data.captureName) {
        if (nameLower.indexOf('first') > -1 || nameLower.indexOf('fname') > -1) {
          processData('firstName', fieldValue);
        }
        else if (nameLower.indexOf('last') > -1 || nameLower.indexOf('lname') > -1) {
          processData('lastName', fieldValue);
        }
        else if (nameLower.indexOf('country') > -1) {
          processData('country', fieldValue);
        }
        else if (nameLower.indexOf('name') > -1 && 
                 nameLower.indexOf('user') === -1 && 
                 nameLower.indexOf('company') === -1 &&
                 nameLower.indexOf('country') === -1) {
          const parts = fieldValue.split(' ');
          if (parts.length >= 2) {
            processData('firstName', parts[0]);
            processData('lastName', parts.slice(1).join(' '));
          } else if (!capturedData.firstName) {
            processData('firstName', fieldValue);
          }
        }
      }
      else if (data.captureAddress) {
        if (nameLower.indexOf('country') > -1) {
          processData('country', fieldValue);
        }
        else if (nameLower.indexOf('address') > -1 || nameLower.indexOf('street') > -1) {
          processData('address', fieldValue);
        }
        else if (nameLower.indexOf('city') > -1) {
          processData('city', fieldValue);
        }
        else if (nameLower.indexOf('zip') > -1 || nameLower.indexOf('postal') > -1) {
          processData('postalCode', fieldValue);
        }
      }
    }
  }
  
  sendData();
};

// Run
processForm();
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "kg_media_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/11/2024