___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "User Data Listener",
  "brand": {
    "id": "kg_media",
    "displayName": "KG Media",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Capture user data from forms, purchases, and interactions without requiring code changes. Automatically listens for email, phone, name, and address data.",
  "categories": ["MARKETING", "PERSONALIZATION", "UTILITY"],
  "containerContexts": ["WEB"]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "captureSettings",
    "displayName": "Data Capture Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "captureEmail",
        "checkboxText": "Capture Email Addresses",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "capturePhone",
        "checkboxText": "Capture Phone Numbers",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "captureName",
        "checkboxText": "Capture Names (First & Last)",
        "simpleValueType": true,
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "captureAddress",
        "checkboxText": "Capture Address Information",
        "simpleValueType": true,
        "defaultValue": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "listenerConfig",
    "displayName": "Listener Configuration",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "listenMode",
        "displayName": "Listen Mode",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "all",
            "displayValue": "All Forms & Interactions"
          },
          {
            "value": "forms",
            "displayValue": "Form Submissions Only"
          },
          {
            "value": "clicks",
            "displayValue": "Click Events Only"
          },
          {
            "value": "custom",
            "displayValue": "Custom Selector"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "all"
      },
      {
        "type": "TEXT",
        "name": "customSelector",
        "displayName": "CSS Selector (for Custom Mode)",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "listenMode",
            "paramValue": "custom",
            "type": "EQUALS"
          }
        ],
        "help": "Enter a CSS selector to limit data capture to specific elements"
      },
      {
        "type": "TEXT",
        "name": "debounceDelay",
        "displayName": "Debounce Delay (ms)",
        "simpleValueType": true,
        "defaultValue": "500",
        "help": "Delay before capturing data to avoid duplicate events"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "dataOutput",
    "displayName": "Data Output Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "outputMethod",
        "displayName": "Output Method",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "dataLayer",
            "displayValue": "Push to dataLayer"
          },
          {
            "value": "localStorage",
            "displayValue": "Save to localStorage"
          },
          {
            "value": "both",
            "displayValue": "Both dataLayer and localStorage"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "dataLayer"
      },
      {
        "type": "TEXT",
        "name": "dataLayerEventName",
        "displayName": "dataLayer Event Name",
        "simpleValueType": true,
        "defaultValue": "userData.captured",
        "enablingConditions": [
          {
            "paramName": "outputMethod",
            "paramValue": "dataLayer",
            "type": "EQUALS"
          },
          {
            "paramName": "outputMethod",
            "paramValue": "both",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "localStorageKey",
        "displayName": "localStorage Key",
        "simpleValueType": true,
        "defaultValue": "kg_media_user_data",
        "enablingConditions": [
          {
            "paramName": "outputMethod",
            "paramValue": "localStorage",
            "type": "EQUALS"
          },
          {
            "paramName": "outputMethod",
            "paramValue": "both",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advancedSettings",
    "displayName": "Advanced Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "hashData",
        "checkboxText": "Hash Sensitive Data (SHA-256)",
        "simpleValueType": true,
        "defaultValue": false,
        "help": "Hash email and phone data before storing"
      },
      {
        "type": "CHECKBOX",
        "name": "gdprMode",
        "checkboxText": "GDPR Mode - Store ONLY hashed data (EU compliance)",
        "simpleValueType": true,
        "defaultValue": false,
        "help": "For EU clients: Only stores hashed email/phone, discards originals. Keeps names for personalization.",
        "enablingConditions": [
          {
            "paramName": "hashData",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "enableLogging",
        "checkboxText": "Enable Console Logging",
        "simpleValueType": true,
        "defaultValue": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const createQueue = require('createQueue');
const copyFromDataLayer = require('copyFromDataLayer');
const localStorage = require('localStorage');
const sha256 = require('sha256');
const queryPermission = require('queryPermission');
const makeString = require('makeString');
const getTimestampMillis = require('getTimestampMillis');
const JSON = require('JSON');
const getType = require('getType');
const isConsentGranted = require('isConsentGranted');

// Check Google Consent Mode
const adStorageGranted = isConsentGranted('ad_storage');
const analyticsStorageGranted = isConsentGranted('analytics_storage');
const adUserDataGranted = isConsentGranted('ad_user_data');
const adPersonalizationGranted = isConsentGranted('ad_personalization');

// Determine if we should proceed based on consent
let shouldProceed = false;

// For analytics purposes, we need analytics_storage
// For advertising purposes, we need ad_storage, ad_user_data, and ad_personalization
if (data.outputMethod === 'dataLayer' || data.outputMethod === 'both') {
  // Check if we have minimum required consent for chosen output method
  if (analyticsStorageGranted || 
      (adStorageGranted && adUserDataGranted && adPersonalizationGranted)) {
    shouldProceed = true;
  }
}

// For localStorage, we should have at least analytics consent
if (data.outputMethod === 'localStorage') {
  if (analyticsStorageGranted) {
    shouldProceed = true;
  }
}

if (!shouldProceed) {
  if (data.enableLogging) {
    log('User Data Listener: Insufficient consent granted. Current consent state:', {
      ad_storage: adStorageGranted,
      analytics_storage: analyticsStorageGranted,
      ad_user_data: adUserDataGranted,
      ad_personalization: adPersonalizationGranted
    });
  }
  data.gtmOnFailure();
  return;
}

// Create dataLayer push function
const dataLayerPush = createQueue('dataLayer');

// Initialize captured data storage
let capturedData = {};

// Process and store data with improved hashing and GDPR compliance
const processData = function(type, value) {
  if (!value || typeof value !== 'string') return;
  
  value = value.trim();
  if (!value) return;
  
  // Store data temporarily
  capturedData[type] = value;
  
  if (data.enableLogging) {
    log('User Data Listener: Captured', type, ':', value);
  }
  
  // Handle hashing for sensitive data
  if (data.hashData && (type === 'email' || type === 'phone')) {
    if (data.enableLogging) {
      log('User Data Listener: Starting hash for', type, 'GDPR Mode:', data.gdprMode);
    }
    
    sha256(value, function(hashedValue) {
      capturedData[type + '_hashed'] = hashedValue;
      
      // GDPR Mode: Remove original sensitive data after hashing
      if (data.gdprMode) {
        capturedData[type] = undefined; // Remove original for GDPR compliance
        if (data.enableLogging) {
          log('User Data Listener: GDPR Mode - Removed original', type, 'after hashing');
        }
      }
      
      if (data.enableLogging) {
        log('User Data Listener: Hash completed for', type, ':', hashedValue);
      }
      
      // Check if this is the last hash we're waiting for
      let allHashesComplete = true;
      if (data.hashData) {
        if (capturedData.email && !capturedData.email_hashed) allHashesComplete = false;
        if (capturedData.phone && !capturedData.phone_hashed) allHashesComplete = false;
      }
      
      // If all hashes are complete, send data
      if (allHashesComplete) {
        if (data.enableLogging) {
          log('User Data Listener: All hashes complete, sending data');
        }
        sendDataAfterHashing();
      }
    }, function() {
      if (data.enableLogging) {
        log('User Data Listener: Hash failed for', type);
      }
      data.gtmOnFailure();
    });
  }
};

// Send captured data with intelligent merging (called immediately for non-hashed data)
const sendData = function() {
  // If hashing is enabled and we have email/phone, wait for hashing to complete
  if (data.hashData && (capturedData.email || capturedData.phone)) {
    if (data.enableLogging) {
      log('User Data Listener: Hashing enabled, waiting for hash completion');
    }
    // Don't send data yet - wait for hash callbacks
    return;
  }
  
  // Proceed with sending data
  sendDataAfterHashing();
};

// Send data after hashing is complete (or immediately if no hashing needed)
const sendDataAfterHashing = function() {
  let hasData = false;
  for (let key in capturedData) {
    if (capturedData.hasOwnProperty(key)) {
      hasData = true;
      break;
    }
  }
  
  if (!hasData) {
    if (data.enableLogging) {
      log('User Data Listener: No data captured');
    }
    return;
  }
  
  if (data.outputMethod === 'dataLayer' || data.outputMethod === 'both') {
    const eventData = {
      event: data.dataLayerEventName
    };
    
    for (let key in capturedData) {
      if (capturedData.hasOwnProperty(key)) {
        eventData['userData.' + key] = capturedData[key];
      }
    }
    
    dataLayerPush(eventData);
    
    if (data.enableLogging) {
      log('User Data Listener: Pushed to dataLayer', eventData);
    }
  }
  
  if (data.outputMethod === 'localStorage' || data.outputMethod === 'both') {
    if (queryPermission('access_local_storage', 'write', data.localStorageKey)) {
      
      // ENHANCED: Read existing data and merge intelligently
      let existingUserData = {};
      let existingData = null;
      const existingDataStr = localStorage.getItem(data.localStorageKey);
      
      if (existingDataStr) {
        existingData = JSON.parse(existingDataStr);
        if (existingData && existingData.userData) {
          existingUserData = existingData.userData;
          if (data.enableLogging) {
            log('User Data Listener: Found existing data to merge:', existingUserData);
          }
        }
      }
      
      // Merge strategy: New data takes precedence, but preserve complementary data
      const mergedUserData = {};
      
      // Copy existing data first
      for (let key in existingUserData) {
        if (existingUserData.hasOwnProperty(key)) {
          mergedUserData[key] = existingUserData[key];
        }
      }
      
      // Add/overwrite with new captured data (excluding undefined values for GDPR mode)
      for (let key in capturedData) {
        if (capturedData.hasOwnProperty(key) && capturedData[key] !== undefined) {
          mergedUserData[key] = capturedData[key];
        }
      }
      
      // Smart handling for related fields
      // If we get a new email, remove the old hashed version since it doesn't match
      if (capturedData.email && existingUserData.email_hashed && capturedData.email !== existingUserData.email) {
        // Remove old hashed email since it doesn't match new email
        mergedUserData.email_hashed = undefined;
      }
      
      if (capturedData.phone && existingUserData.phone_hashed && capturedData.phone !== existingUserData.phone) {
        // Remove old hashed phone since it doesn't match new phone
        mergedUserData.phone_hashed = undefined;
      }
      
      const dataToStore = {
        timestamp: makeString(getTimestampMillis()),
        source: 'kg_media_user_data_listener',
        lastUpdated: makeString(getTimestampMillis()),
        updateCount: (existingData && existingData.updateCount) ? existingData.updateCount + 1 : 1,
        userData: mergedUserData
      };
      
      localStorage.setItem(data.localStorageKey, JSON.stringify(dataToStore));
      
      if (data.enableLogging) {
        log('User Data Listener: Merged and saved to localStorage', {
          previousData: existingUserData,
          newData: capturedData,
          mergedResult: mergedUserData,
          updateCount: dataToStore.updateCount,
          gdprMode: data.gdprMode,
          hashingEnabled: data.hashData
        });
      }
    }
  }
};

// Main function to process form
const processForm = function() {
  if (data.enableLogging) {
    log('User Data Listener: Starting form processing');
  }
  
  // Get the entire gtm object
  const gtmData = copyFromDataLayer('gtm');
  if (data.enableLogging && gtmData) {
    log('User Data Listener: GTM data available', gtmData);
  }
  
  // Try multiple ways to get form data
  // Method 1: Check for form fields in Click Element variables
  const clickElement = copyFromDataLayer('gtm.element');
  const elementId = copyFromDataLayer('gtm.elementId');
  const elementClasses = copyFromDataLayer('gtm.elementClasses');
  const elementUrl = copyFromDataLayer('gtm.elementUrl');
  
  if (data.enableLogging) {
    log('User Data Listener: Form submission detected', {
      elementId: elementId,
      elementClasses: elementClasses,
      hasClickElement: !!clickElement
    });
  }
  
  // Method 2: Try to get values from GTM's auto-collected form data
  // GTM sometimes provides form field values in different formats
  const possibleFields = [
    // Direct form fields
    'gtm.element.email.value',
    'gtm.element.phone.value',
    'gtm.element.tel.value',
    'gtm.element.name.value',
    'gtm.element.firstName.value',
    'gtm.element.lastName.value',
    'gtm.element.first_name.value',
    'gtm.element.last_name.value',
    'gtm.element.address.value',
    'gtm.element.city.value',
    'gtm.element.zip.value',
    'gtm.element.postal.value',
    'gtm.element.country.value',
    // Form elements array
    'gtm.element.elements.email.value',
    'gtm.element.elements.phone.value',
    'gtm.element.elements.tel.value',
    'gtm.element.elements.name.value',
    'gtm.element.elements.firstName.value',
    'gtm.element.elements.lastName.value',
    'gtm.element.elements.first_name.value',
    'gtm.element.elements.last_name.value',
    'gtm.element.elements.address.value',
    'gtm.element.elements.city.value',
    'gtm.element.elements.zip.value',
    'gtm.element.elements.postal.value',
    'gtm.element.elements.country.value'
  ];
  
  // Try each possible field path
  possibleFields.forEach(function(fieldPath) {
    const value = copyFromDataLayer(fieldPath);
    if (value && getType(value) === 'string') {
      if (data.enableLogging) {
        log('User Data Listener: Found value at', fieldPath, ':', value);
      }
      
      // Determine field type from path
      const pathLower = fieldPath.toLowerCase();
      
      if (data.captureEmail && pathLower.indexOf('email') > -1) {
        if (value.indexOf('@') > 0) {
          processData('email', value);
        }
      }
      else if (data.capturePhone && (pathLower.indexOf('phone') > -1 || pathLower.indexOf('tel') > -1)) {
        processData('phone', value);
      }
      else if (data.captureName) {
        if (pathLower.indexOf('firstname') > -1 || pathLower.indexOf('first_name') > -1 || pathLower.indexOf('fname') > -1) {
          processData('firstName', value);
        }
        else if (pathLower.indexOf('lastname') > -1 || pathLower.indexOf('last_name') > -1 || pathLower.indexOf('lname') > -1) {
          processData('lastName', value);
        }
        else if (pathLower.indexOf('country') > -1) {
          processData('country', value);
        }
        else if (pathLower.indexOf('name') > -1 && 
                 pathLower.indexOf('user') === -1 && 
                 pathLower.indexOf('company') === -1 &&
                 pathLower.indexOf('country') === -1) {
          const parts = value.split(' ');
          if (parts.length >= 2) {
            processData('firstName', parts[0]);
            processData('lastName', parts.slice(1).join(' '));
          } else if (!capturedData.firstName) {
            processData('firstName', value);
          }
        }
      }
      else if (data.captureAddress) {
        if (pathLower.indexOf('address') > -1 || pathLower.indexOf('street') > -1) {
          processData('address', value);
        }
        else if (pathLower.indexOf('city') > -1) {
          processData('city', value);
        }
        else if (pathLower.indexOf('zip') > -1 || pathLower.indexOf('postal') > -1) {
          processData('postalCode', value);
        }
        else if (pathLower.indexOf('country') > -1) {
          processData('country', value);
        }
      }
    }
  });
  
  // Method 3: Try to access form data from Auto-Event Variables
  // Sometimes GTM stores form data in numbered indices
  for (let i = 0; i < 50; i++) {
    const fieldName = copyFromDataLayer('gtm.element.elements.' + i + '.name');
    const fieldValue = copyFromDataLayer('gtm.element.elements.' + i + '.value');
    const fieldType = copyFromDataLayer('gtm.element.elements.' + i + '.type');
    
    if (fieldName && fieldValue) {
      if (data.enableLogging) {
        log('User Data Listener: Found indexed field', i, ':', fieldName, '=', fieldValue);
      }
      
      const nameLower = fieldName.toLowerCase();
      const typeLower = (fieldType || '').toLowerCase();
      
      if (data.captureEmail && (typeLower === 'email' || nameLower.indexOf('email') > -1)) {
        if (fieldValue.indexOf('@') > 0) {
          processData('email', fieldValue);
        }
      }
      else if (data.capturePhone && (typeLower === 'tel' || nameLower.indexOf('phone') > -1 || nameLower.indexOf('tel') > -1)) {
        processData('phone', fieldValue);
      }
      else if (data.captureName) {
        if (nameLower.indexOf('first') > -1 || nameLower.indexOf('fname') > -1) {
          processData('firstName', fieldValue);
        }
        else if (nameLower.indexOf('last') > -1 || nameLower.indexOf('lname') > -1) {
          processData('lastName', fieldValue);
        }
        else if (nameLower === 'name' || (nameLower.indexOf('name') > -1 && 
                 nameLower.indexOf('user') === -1 && 
                 nameLower.indexOf('country') === -1 && 
                 nameLower.indexOf('company') === -1 &&
                 nameLower.indexOf('full') === -1)) {
          const parts = fieldValue.split(' ');
          if (parts.length >= 2) {
            processData('firstName', parts[0]);
            processData('lastName', parts.slice(1).join(' '));
          } else if (!capturedData.firstName) {  // Only set if firstName not already captured
            processData('firstName', fieldValue);
          }
        }
      }
      else if (data.captureAddress) {
        if (nameLower.indexOf('country') > -1) {
          processData('country', fieldValue);
        }
        else if (nameLower.indexOf('address') > -1 || nameLower.indexOf('street') > -1) {
          processData('address', fieldValue);
        }
        else if (nameLower.indexOf('city') > -1) {
          processData('city', fieldValue);
        }
        else if (nameLower.indexOf('zip') > -1 || nameLower.indexOf('postal') > -1) {
          processData('postalCode', fieldValue);
        }
      }
    }
  }
  
  // Send any captured data
  sendData();
};

// Initialize and process
if (data.enableLogging) {
  log('User Data Listener: Initialized with config', {
    captureEmail: data.captureEmail,
    capturePhone: data.capturePhone,
    captureName: data.captureName,
    captureAddress: data.captureAddress,
    listenMode: data.listenMode,
    outputMethod: data.outputMethod
  });
}

// Process the form
processForm();

// Call gtmOnSuccess to indicate successful initialization
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "kg_media_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Basic Email Capture Test
  code: |-
    const mockData = {
      captureEmail: true,
      capturePhone: false,
      captureName: false,
      captureAddress: false,
      listenMode: 'forms',
      outputMethod: 'dataLayer',
      dataLayerEventName: 'userData.captured',
      debounceDelay: '100',
      enableLogging: true
    };

    // Run the template code
    runCode(mockData);

    // Verify initialization
    assertApi('addEventCallback').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();

- name: Permission Test
  code: |-
    const mockData = {
      captureEmail: true,
      listenMode: 'forms',
      outputMethod: 'localStorage',
      localStorageKey: 'test_user_data'
    };

    // Run the template code
    runCode(mockData);

    // Verify permissions were checked
    assertApi('queryPermission').wasCalled();

- name: Consent Check Test
  code: |-
    const mockData = {
      captureEmail: true,
      listenMode: 'forms',
      outputMethod: 'dataLayer'
    };

    // Mock insufficient consent
    mock('isConsentGranted', () => false);

    // Run the template code
    runCode(mockData);

    // Should exit early due to no consent
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 6/11/2025, 4:30:00 PM

Enhanced version with:
- Removed redundant Cookie Consent Variable field
- Added intelligent data merging to preserve existing user data
- Smart hash management for email/phone changes
- Update tracking with timestamps and counters
- Full Google Consent Mode integration only